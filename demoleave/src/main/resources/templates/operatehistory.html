<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <meta charset="UTF-8">
    <title>History Page</title>
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg bg-light fixed-top shadow-lg">
    <div class="container">
        <a style="font-family: 'Gigi', sans-serif" class="navbar-brand" href="#">Gra<span class="redfont">nny</span><span class="greenfont">Leave</span></a>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link click-scroll" href="/Manager">Home</a>
                </li>

                <li class="nav-item">
                    <a class="nav-link click-scroll" href="/Manager/Done">View History</a>
                </li>

                <li class="nav-item">
                    <a class="nav-link click-scroll" href="/login">Login</a>
                </li>
                
                <li class="nav-item">
                    <a class="nav-link click-scroll" href="/logout">Logout</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div th:fragment="content">
    <table id="table1" class="table-borderless table-sm align-middle"
           style="font-family: 'Consolas', sans-serif; width:800px;margin-right: auto;margin-left: auto;margin-top:100px;align-content: center">
        <tr>
            <td width="80%"></td>
            <td>
    			<form action="#" th:action="@{/Manager/Done}" method="get">
        			<div class="input-group mb-3">
			 	        <select name="size" class="form-select" style="height: 38px">
			                <option value="2" th:attr="selected=${leavesPage.size == 2}">2</option>
			                <option value="4" th:attr="selected=${leavesPage.size == 4}">4</option>
			                <option value="8" th:attr="selected=${leavesPage.size == 8}">8</option>
			            </select>
			            <button type="submit" class="btn btn-outline-secondary">
			                Change<i class="bi bi-file-ruled"></i>
			            </button>
        			</div>
    			</form>
			</td>

        </tr>
        <tr>
            <td colspan="2">
                <table id="Mytable" class="table table-striped table-hover table-bordered border-primary-subtle">
                    <thead class="table-secondary">
                    <tr class="text-center">
						<th>ApplicationID</th>
                        <th>User ID</th>
			            <th>Leave Type</th>
			            <th>Start Date</th>
			            <th>End Date</th>
			            <th>Status</th>
			            <th>Approver ID</th>
			            <th>Approve Date</th>
			            <th>Operate</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr class="text-center" th:each="leave : ${leavesPage.content}" th:if="${leave.status == 'Approved' or leave.status == 'Rejected'}">
    					<td class="text-center" th:text="${leave.ApplicationId}"></td>
    					<td th:text="${leave.UserID}"></td>
    					<td th:text="${leave.LeaveType}"></td>
    					<td th:text="${leave.StartDate}"></td>
    					<td th:text="${leave.EndDate}"></td>
    					<td th:text="${leave.Status}"></td>
    					<td th:text="${leave.ApproverID}"></td>
    					<td th:text="${#temporals.format(leave.ApproveDate, 'yyyy-MM-dd HH:mm:ss')}"></td>

    					<td><a th:href="@{/operateLeave(applicationId=${leave.ApplicationId})}">Info</a></td>
					</tr>


                </table>
            </td>
        </tr>
        <tr><td></td>
			<td>
				<button type="button" onclick="exportToCSV()">Save the Table</button>
				
			</td>
		</tr>

    </table>
</div>


<script>
    function exportToCSV() {
        // 获取表格数据
        var table = document.getElementById("Mytable");
        var data = [];

        // 遍历表格行

		for (var i = 0, row; row = table.rows[i]; i++) {
		    var rowData = [];
		
		    // 遍历行中的每个单元格
		    for (var j = 0; j < row.cells.length - 1; j++) {
    			if (j === 3 || j === 4 || j === 7) {
        			// Replace `yourDateColumnIndex` with the actual index of the date column
        			// Format the date
        			rowData.push(formatDate(row.cells[j].innerText)); // Implement the formatDate function
    			}
    			else 
    			{
        			rowData.push(row.cells[j].innerText);
    			}
			}

		
		    // 将行数据添加到主数据数组
		    data.push(rowData);
		

        }

		console.log(data);

        // 使用Papa.parse将数据转换为CSV格式
        var csv = Papa.unparse(data);

        // 创建包含CSV数据的Blob
        var blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });

        // 创建一个触发下载的链接元素
        var link = document.createElement("a");
        if (link.download !== undefined) {
            var url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "table_data.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link); // 移除链接元素
        }
    }
    
	function formatDate(dateString) {
    // 这里你需要根据你的日期字符串的实际格式编写逻辑
    var date = new Date(dateString);
    var formattedDate = date.toLocaleString(); // 这是一个简单的格式化示例，根据需要进行修改
    return formattedDate;
}

</script>




<!-- 分页控制 -->
<div>
    <ul class="pagination justify-content-center">
        <li class="page-item" th:classappend="${leavesPage.hasPrevious() ? '' : 'disabled'}">
            <a class="page-link" th:href="@{/Manager/Leaves(page=${leavesPage.number - 1}, size=${leavesPage.size})}"
               aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
            </a>
        </li>
        <li th:each="pageNum : ${#numbers.sequence(0, leavesPage.totalPages - 1)}" class="page-item"
            th:classappend="${pageNum == leavesPage.number ? 'active' : ''}">
            <a class="page-link" th:href="@{/Manager/Leaves(page=${pageNum}, size=${leavesPage.size})}"
               th:text="${pageNum + 1}"></a>
        </li>
        <li class="page-item" th:classappend="${leavesPage.hasNext() ? '' : 'disabled'}">
            <a class="page-link" th:href="@{/Manager/Leaves(page=${leavesPage.number + 1}, size=${leavesPage.size})}"
               aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
            </a>
        </li>
    </ul>
</div>

<!--<form action="/Admin/addLeave" method="post">-->
<!--    <label for="userId">UserId:</label>-->
<!--    <input type="number" id="userId" name="userId" required>-->
<!--    <label for="year">year:</label>-->
<!--    <input type="number" id="year" min="1901" max="2099" name="year" required>-->
<!--    <label for="AnnualRemain">AnnualRemain:</label>-->
<!--    <input type="number" min="0" id="AnnualRemain" name="AnnualRemain">-->
<!--    <label for="SickRemain">SickRemain:</label>-->
<!--    <input type="number" min="0" id="SickRemain" name="SickRemain">-->
<!--    <label for="CompensationRemain">CompensationRemain:</label>-->
<!--    <input type="number" min="0" id="CompensationRemain" name="CompensationRemain">-->
<!--    <input type="submit" value="Add LeaveRemain">-->
<!--</form>-->
</body>
</html>
